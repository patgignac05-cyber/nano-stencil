<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-TREME ENGINE v84 — FULL TOOLS</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        :root { --accent: #c8f53a; --bg: #050505; --panel: #0f0f13; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { 
            width: 340px; background: var(--panel); border-right: 2px solid #1e1e28; 
            display: flex; flex-direction: column; padding: 20px; gap: 12px; 
            overflow-y: auto; 
        }

        .logo { color: var(--accent); font-weight: 900; font-size: 18px; margin-bottom: 10px; }
        .tool-box { background: #16161d; padding: 15px; border-radius: 8px; border: 1px solid #252531; }
        h3 { font-size: 9px; color: var(--accent); margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 2px; }
        .val { float: right; color: #666; font-size: 11px; }

        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--accent); height: 4px; }
        
        #main { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #000; }
        .canvas-container { background: #080808; border: 1px solid #151515; position: relative; display: flex; align-items: center; justify-content: center; }
        .label { position: absolute; top: 10px; left: 10px; font-size: 9px; color: var(--accent); background: rgba(0,0,0,0.8); padding: 4px 8px; z-index: 5; }
        canvas { max-width: 98%; max-height: 98%; }
        
        .btn-dl { background: #ff3d6e; color: white; border: none; padding: 18px; font-weight: bold; cursor: pointer; border-radius: 6px; text-transform: uppercase; margin-top: 5px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="logo">X-TREME ENGINE PRO</div>
    
    <div class="tool-box">
        <h3>1. SOURCE</h3>
        <input type="file" id="imgIn" style="width: 100%; font-size: 11px;">
    </div>

    <div class="tool-box">
        <h3>2. EXTRACTION DÉTAILS <span id="v-sharp" class="val">1.5</span></h3>
        <input type="range" id="sharp" min="0" max="5" step="0.1" value="1.5">
    </div>

    <div class="tool-box">
        <h3>3. LISSAGE / SOFTEN <span id="v-blur" class="val">0</span></h3>
        <input type="range" id="blur" min="0" max="4" step="0.5" value="0">
    </div>

    <div class="tool-box">
        <h3>4. SEUIL NOIR (STENCIL) <span id="v-thresh" class="val">128</span></h3>
        <input type="range" id="thresh" min="0" max="255" value="128">
    </div>

    <div class="tool-box">
        <h3>5. ÉPAISSEUR TRAIT <span id="v-bold" class="val">0</span></h3>
        <input type="range" id="bold" min="0" max="5" step="0.5" value="0">
    </div>

    <div class="tool-box">
        <h3>6. GREYWASH / OMBRES <span id="v-grey" class="val">100</span>%</h3>
        <input type="range" id="grey" min="0" max="100" value="100">
    </div>

    <button class="btn-dl" onclick="download()">Exporter Stencil HD</button>
    <button onclick="netlifyIdentity.logout()" style="color:#444; background:none; border:none; cursor:pointer; font-size:10px; text-decoration: underline;">Déconnexion</button>
</div>

<div id="main">
    <div class="canvas-container"><div class="label">ANALYSE DÉTAILS</div><canvas id="c0"></canvas></div>
    <div class="canvas-container"><div class="label">STENCIL FINAL</div><canvas id="c1"></canvas></div>
</div>

<script>
    netlifyIdentity.init();
    const d = document;
    const cvs = [d.getElementById('c0'), d.getElementById('c1')];
    const ctx = cvs.map(c => c.getContext('2d', { willReadFrequently: true }));
    let imgSource = null;

    ['thresh', 'bold', 'sharp', 'blur', 'grey'].forEach(id => {
        d.getElementById(id).oninput = (e) => {
            d.getElementById('v-'+id).innerText = e.target.value;
            render();
        };
    });

    d.getElementById('imgIn').onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => {
            imgSource = new Image();
            imgSource.onload = () => {
                const ratio = imgSource.height / imgSource.width;
                cvs.forEach(c => { c.width = 1600; c.height = 1600 * ratio; });
                render();
            };
            imgSource.src = ev.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function render() {
        if(!imgSource) return;
        const w = cvs[0].width, h = cvs[0].height;
        const t = parseInt(d.getElementById('thresh').value);
        const b = parseFloat(d.getElementById('bold').value);
        const s = parseFloat(d.getElementById('sharp').value);
        const bl = parseFloat(d.getElementById('blur').value);
        const g = parseInt(d.getElementById('grey').value) / 100;

        // Étape 1 : Analyse (Netteté + Contraste)
        ctx[0].filter = `grayscale(1) contrast(${100 + s * 50}%) blur(${bl}px)`;
        ctx[0].drawImage(imgSource, 0, 0, w, h);

        // Étape 2 : Stencil avec Épaisseur et Greywash
        ctx[1].fillStyle = "white";
        ctx[1].fillRect(0,0,w,h);
        
        // Simulation d'épaisseur (Dilatation légère)
        if (b > 0) {
            ctx[1].filter = `grayscale(1) contrast(1000%) blur(${b}px)`;
        } else {
            ctx[1].filter = `grayscale(1) contrast(1000%)`;
        }
        
        const idata = ctx[0].getImageData(0,0,w,h);
        const data = idata.data;
        for(let i=0; i<data.length; i+=4) {
            let gray = (data[i] + data[i+1] + data[i+2]) / 3;
            // On applique le seuil et le facteur d'ombre
            let final = gray > t ? 255 : (255 * (1 - g));
            data[i] = data[i+1] = data[i+2] = final;
        }
        ctx[1].putImageData(idata, 0, 0);
    }

    function download() {
        const link = d.createElement('a');
        link.download = 'XTREME-PRO-STENCIL.png';
        link.href = cvs[1].toDataURL('image/png', 1.0);
        link.click();
    }
</script>
</body>
</html>
